<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Antfarm Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0d1117;color:#c9d1d9;min-height:100vh}
header{background:#161b22;border-bottom:1px solid #30363d;padding:16px 24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
header h1{font-size:18px;font-weight:600;color:#e6edf3}
header h1 span{color:#58a6ff}
select{background:#0d1117;color:#c9d1d9;border:1px solid #30363d;border-radius:6px;padding:6px 12px;font-size:14px;cursor:pointer}
select:focus{outline:none;border-color:#58a6ff}
.board{display:flex;gap:16px;padding:24px;overflow-x:auto;min-height:calc(100vh - 65px)}
.column{min-width:240px;flex:1;background:#161b22;border:1px solid #30363d;border-radius:8px;display:flex;flex-direction:column}
.column-header{padding:12px 16px;border-bottom:1px solid #30363d;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#8b949e}
.column-header .count{background:#30363d;color:#c9d1d9;border-radius:10px;padding:1px 8px;font-size:11px;margin-left:8px}
.cards{padding:8px;flex:1;display:flex;flex-direction:column;gap:8px;overflow-y:auto}
.card{background:#0d1117;border:1px solid #30363d;border-radius:6px;padding:12px;cursor:pointer;transition:border-color .15s}
.card:hover{border-color:#58a6ff}
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s}
.overlay.open{opacity:1;pointer-events:auto}
.panel{background:#161b22;border:1px solid #30363d;border-radius:12px;width:90%;max-width:640px;max-height:85vh;overflow-y:auto;padding:24px;position:relative}
.panel-close{position:absolute;top:12px;right:16px;background:none;border:none;color:#8b949e;font-size:20px;cursor:pointer;padding:4px 8px;border-radius:4px}
.panel-close:hover{color:#e6edf3;background:#30363d}
.panel h2{font-size:16px;font-weight:600;color:#e6edf3;margin-bottom:4px;padding-right:40px}
.panel-task{font-size:13px;color:#8b949e;margin-bottom:16px;white-space:pre-wrap;word-break:break-word;max-height:120px;overflow-y:auto;line-height:1.5}
.panel-meta{display:flex;gap:12px;margin-bottom:20px;font-size:12px;color:#8b949e;flex-wrap:wrap}
.panel-meta span{display:flex;align-items:center;gap:4px}
.steps-list{display:flex;flex-direction:column;gap:8px}
.step-row{display:flex;align-items:center;gap:12px;padding:10px 12px;background:#0d1117;border:1px solid #30363d;border-radius:6px}
.step-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
.step-icon.done{background:#23863633;color:#3fb950}
.step-icon.running{background:#1f6feb33;color:#58a6ff}
.step-icon.pending{background:#30363d;color:#8b949e}
.step-icon.waiting{background:#30363d;color:#8b949e}
.step-icon.failed,.step-icon.error{background:#da363333;color:#f85149}
.step-name{font-size:13px;font-weight:500;color:#e6edf3;flex:1}
.step-agent{font-size:11px;color:#484f58}
.step-status{font-size:11px;text-transform:uppercase;font-weight:600}
.card-title{font-size:13px;font-weight:500;color:#e6edf3;margin-bottom:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.card-meta{font-size:11px;color:#8b949e;display:flex;justify-content:space-between;align-items:center}
.badge{font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px;text-transform:uppercase}
.badge-running{background:#1f6feb33;color:#58a6ff}
.badge-done{background:#23863633;color:#3fb950}
.badge-failed,.badge-error{background:#da363333;color:#f85149}
.badge-waiting{background:#30363d;color:#8b949e}
.badge-blocked{background:#6e401033;color:#d29922}
.card.done{border-left:3px solid #3fb950}
.card.failed,.card.error{border-left:3px solid #f85149}
.empty{color:#484f58;font-size:12px;text-align:center;padding:24px 8px}
.refresh-note{color:#484f58;font-size:11px;margin-left:auto}
@media(max-width:768px){.board{flex-direction:column}.column{min-width:unset}}
</style>
</head>
<body>
<header>
  <h1>üêú <span>antfarm</span> dashboard</h1>
  <select id="wf-select"><option value="">Loading...</option></select>
  <span class="refresh-note" id="refresh-note">Auto-refresh: 30s</span>
</header>
<div class="board" id="board"><div class="empty" style="margin:auto">Select a workflow</div></div>
<div class="overlay" id="overlay" onclick="if(event.target===this)closePanel()">
  <div class="panel" id="panel"></div>
</div>

<script>
const API = '';
let workflows = [];
let currentWf = null;

async function fetchJSON(url) {
  const r = await fetch(API + url);
  return r.json();
}

async function loadWorkflows() {
  workflows = await fetchJSON('/api/workflows');
  const sel = document.getElementById('wf-select');
  sel.innerHTML = '<option value="">‚Äî select workflow ‚Äî</option>' +
    workflows.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
  if (workflows.length === 1) {
    sel.value = workflows[0].id;
    selectWorkflow(workflows[0].id);
  }
}

function selectWorkflow(id) {
  currentWf = workflows.find(w => w.id === id) || null;
  if (currentWf) loadRuns();
  else document.getElementById('board').innerHTML = '<div class="empty" style="margin:auto">Select a workflow</div>';
}

async function loadRuns() {
  if (!currentWf) return;
  const runs = await fetchJSON(`/api/runs?workflow=${currentWf.id}`);
  renderBoard(currentWf, runs);
}

function getActiveStepId(run) {
  if (!run.steps || !run.steps.length) return null;
  const active = run.steps.find(s => s.status !== 'done' && s.status !== 'skipped');
  return active ? active.step_id : run.steps[run.steps.length - 1].step_id;
}

function renderBoard(wf, runs) {
  const board = document.getElementById('board');
  const columns = {};
  wf.steps.forEach(s => { columns[s.id] = []; });

  runs.forEach(run => {
    const stepId = getActiveStepId(run);
    const col = stepId && columns[stepId] !== undefined ? stepId : wf.steps[wf.steps.length - 1]?.id;
    if (col && columns[col]) columns[col].push(run);
  });

  board.innerHTML = wf.steps.map(step => {
    const cards = columns[step.id];
    const cardHTML = cards.length === 0
      ? '<div class="empty">No runs</div>'
      : cards.map(run => {
          const isDone = run.status === 'done';
          const isFailed = run.status === 'failed' || run.status === 'error';
          const cls = isDone ? 'done' : isFailed ? 'failed' : '';
          const badge = `badge-${run.status}`;
          const time = run.updated_at ? new Date(run.updated_at).toLocaleString() : '';
          const title = run.task.length > 60 ? run.task.slice(0, 57) + '‚Ä¶' : run.task;
          return `<div class="card ${cls}" onclick="openRun('${run.id}')">
            <div class="card-title" title="${run.task.replace(/"/g, '&quot;')}">${title}</div>
            <div class="card-meta">
              <span class="badge ${badge}">${run.status}</span>
              <span>${time}</span>
            </div>
          </div>`;
        }).join('');
    return `<div class="column">
      <div class="column-header">${step.id}<span class="count">${cards.length}</span></div>
      <div class="cards">${cardHTML}</div>
    </div>`;
  }).join('');
}

const stepIcons = {done:'‚úì',running:'‚óè',pending:'‚óã',waiting:'‚óå',failed:'‚úó',error:'‚úó'};

async function openRun(id) {
  const run = await fetchJSON(`/api/runs/${id}`);
  const panel = document.getElementById('panel');
  const created = run.created_at ? new Date(run.created_at).toLocaleString() : '';
  const updated = run.updated_at ? new Date(run.updated_at).toLocaleString() : '';
  const stepsHTML = (run.steps || []).map(s => {
    const st = s.status || 'waiting';
    const icon = stepIcons[st] || '‚óã';
    return `<div class="step-row">
      <div class="step-icon ${st}">${icon}</div>
      <div class="step-name">${s.step_id}</div>
      <div class="step-agent">${s.agent_id || ''}</div>
      <div class="step-status"><span class="badge badge-${st}">${st}</span></div>
    </div>`;
  }).join('');
  panel.innerHTML = `
    <button class="panel-close" onclick="closePanel()">‚úï</button>
    <h2>${run.workflow_id}</h2>
    <div class="panel-task">${run.task}</div>
    <div class="panel-meta">
      <span><span class="badge badge-${run.status}">${run.status}</span></span>
      <span>Created: ${created}</span>
      <span>Updated: ${updated}</span>
    </div>
    <div class="steps-list">${stepsHTML}</div>
  `;
  document.getElementById('overlay').classList.add('open');
}

function closePanel() {
  document.getElementById('overlay').classList.remove('open');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePanel(); });

document.getElementById('wf-select').addEventListener('change', e => selectWorkflow(e.target.value));
loadWorkflows();
setInterval(() => { if (currentWf) loadRuns(); }, 30000);
</script>
</body>
</html>
